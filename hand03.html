<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hand Tracking + micro:bit BLE</title>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <style>
    body { background:#111; color:white; text-align:center; font-family:Arial; }
    #output_canvas{ width:480px; height:360px; border:1px solid #444; }
    #status { margin:10px; font-size:18px; color:#0f0; }
    #bleStatus { margin:10px; color:yellow; }
    #connectBtn{ padding:10px 18px; font-size:16px; }
  </style>
</head>

<body>
  <h2>Hand Tracking + micro:bit BLE</h2>

  <button id="connectBtn">Connect</button>
  <div id="bleStatus">Not Connected</div>

  <div id="status">Waiting...</div>

  <video id="video" autoplay playsinline style="display:none;"></video>
  <canvas id="output_canvas"></canvas>

<script>
/* ============================================================
   CANVAS & VIDEO SETUP
============================================================ */
const video = document.getElementById("video");
const canvas = document.getElementById("output_canvas");
const ctx = canvas.getContext("2d");
const statusBox = document.getElementById("status");

async function initCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({ video:true });
  video.srcObject = stream;
}
initCamera();

/* ============================================================
   DRAW SMALL CROSS
============================================================ */
function drawCross(ctx,x,y,size,color){
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(x-size, y-size);
  ctx.lineTo(x+size, y+size);
  ctx.moveTo(x+size, y-size);
  ctx.lineTo(x-size, y+size);
  ctx.stroke();
}

/* ============================================================
   GESTURE STATE VARIABLES
============================================================ */
let lastMovement = "STOP";
let lastHandState = "OPEN";

/* ============================================================
   MAIN HAND PROCESSOR
============================================================ */
function onResults(results){
  ctx.save();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(results.image,0,0,canvas.width,canvas.height);

  if(results.multiHandLandmarks){
    const lm = results.multiHandLandmarks[0];

    /* Draw skeleton and landmarks */
    drawConnectors(ctx, lm, HAND_CONNECTIONS, {color:"#00FFAA", lineWidth:2});
    lm.forEach(p => {
      drawCross(ctx, p.x*canvas.width, p.y*canvas.height, 1, "#FF4444");
    });

    /* --------------------------------------------------------
       MOVEMENT DETECTION (USING WRIST ONLY)
    -------------------------------------------------------- */
    const wrist = lm[0];
    const x = wrist.x;
    const y = wrist.y;

    // Your thresholds
    const left = 0.4;
    const right = 0.6;
    const top = 0.5;
    const bottom = 0.7;

    let movement = "STOP";
    if (x < left) movement = "LEFT";
    else if (x > right) movement = "RIGHT";
    else if (y < top) movement = "UP";
    else if (y > bottom) movement = "DOWN";
    else movement = "STOP";

    /* --------------------------------------------------------
       HAND GESTURE DETECTION (Version A)
       - PICK-UP when 4,8,12 very close
       - OPEN HAND when average finger-tip spread is wide
    -------------------------------------------------------- */

    // Distances
    function dist(a,b){
      return Math.hypot(a.x - b.x, a.y - b.y);
    }

    const d48 = dist(lm[4], lm[8]);
    const d412 = dist(lm[4], lm[12]);
    const d812 = dist(lm[8], lm[12]);

    let handState = "OPEN";

    if (d48 < 0.06 && d412 < 0.06 && d812 < 0.06){
      handState = "PICK-UP";
    } else {
      // OPEN hand = average spread of fingertips from wrist
      const tips = [lm[4], lm[8], lm[12], lm[16], lm[20]];
      let sum = 0;
      for (let t of tips) sum += dist(lm[0], t);
      const avg = sum / 5;

      handState = (avg > 0.22 ? "OPEN" : "PICK-UP");  
    }

    /* --------------------------------------------------------
       CHANGE-ONLY OUTPUT
    -------------------------------------------------------- */
    if (movement !== lastMovement){
      lastMovement = movement;
      statusBox.textContent = movement;
      if (isConnected){
        if (movement === "LEFT") sendUART("l");
        if (movement === "RIGHT") sendUART("r");
        if (movement === "UP") sendUART("f");
        if (movement === "DOWN") sendUART("b");
        if (movement === "STOP") sendUART("s");
      }
    }

    if (handState !== lastHandState){
      lastHandState = handState;
      statusBox.textContent = handState;
      if (isConnected){
        if (handState === "OPEN") sendUART("o");
        if (handState === "PICK-UP") sendUART("p");
      }
    }
  }
  ctx.restore();
}

/* ============================================================
   MEDIAPIPE SETUP
============================================================ */
const hands = new Hands({
  locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});
hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:0.6,
  minTrackingConfidence:0.6
});
hands.onResults(onResults);

const camera = new Camera(video,{
  onFrame: async()=>{ await hands.send({image:video}); },
  width:480, height:360
});
camera.start();

/* ============================================================
   MICRO:BIT BLE UART
============================================================ */
const UART_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const UART_TX_CHARACTERISTIC_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; 
const UART_RX_CHARACTERISTIC_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; 

let device = null;
let rxChar = null;
let isConnected = false;

async function connectMicrobit(){
  try {
    document.getElementById("bleStatus").textContent = "Scanning...";

    device = await navigator.bluetooth.requestDevice({
      filters:[{namePrefix:"BBC micro:bit"},{namePrefix:"micro:bit"}],
      optionalServices:[UART_SERVICE_UUID]
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(UART_SERVICE_UUID);

    // RX = WRITE
    rxChar = await service.getCharacteristic(UART_RX_CHARACTERISTIC_UUID);

    isConnected = true;
    document.getElementById("connectBtn").textContent = "Disconnect";
    document.getElementById("bleStatus
